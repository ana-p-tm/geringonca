<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERINGON√áA | Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; color: #334155; }
        .card-solid { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-emerald { background-color: #059669; color: white; font-weight: 700; transition: all 0.2s; }
        .btn-emerald:hover { background-color: #047857; transform: translateY(-1px); }
        .btn-amber { background-color: #d97706; color: white; font-weight: 700; }
        input, select { border: 1px solid #e2e8f0 !important; border-radius: 0.75rem !important; padding: 0.75rem !important; outline: none !important; }
        input:focus { border-color: #059669 !important; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important; }
        .active-chip { background-color: #059669 !important; color: white !important; }
        [x-cloak] { display: none !important; }
        .filter-btn { font-size: 0.65rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; color: #94a3b8; transition: all 0.2s; }
        .filter-btn.active { background: #334155; color: white; border-color: #334155; }
        .cat-tag { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    </style>
</head>
<body x-data="app()" x-init="init()" x-cloak>

    <template x-if="!logged">
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
                <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-2 uppercase tracking-tighter">Geringon√ßa</h2>
                <input type="password" x-model="passInput" @keydown.enter="checkPass()" class="w-full text-center text-2xl mb-4" placeholder="Senha">
                <button @click="checkPass()" class="w-full btn-emerald py-4 rounded-xl uppercase text-xs">Entrar</button>
            </div>
        </div>
    </template>

    <div x-show="logged" class="max-w-6xl mx-auto p-4 md:p-10">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-black text-[#064e3b] uppercase italic">GERINGON√áA</h1>
            <button @click="logout()" class="text-slate-400 hover:text-red-500 text-xs font-bold uppercase">Sair <i class="fas fa-sign-out-alt"></i></button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="card-solid">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 uppercase text-xs tracking-widest">Integrantes</h3>
                    <div class="flex gap-2 mb-6">
                        <input type="text" x-model="newName" @keydown.enter="addP()" class="flex-1 text-sm" placeholder="Novo nome...">
                        <button @click="addP()" class="btn-emerald px-4 rounded-xl">+</button>
                    </div>
                    <div class="space-y-2">
                        <template x-for="p in peopleList" :key="p.id">
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl group hover:bg-white border border-transparent hover:border-slate-100 transition-all">
                                <span class="font-semibold text-slate-700" x-text="p.name"></span>
                                <button @click="removeP(p.id)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-user-minus"></i></button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="card-solid border-t-4 border-t-emerald-600">
                    <h3 class="font-bold text-slate-800 mb-6 uppercase text-xs tracking-widest text-center">Resumo Geral</h3>
                    <div class="space-y-5">
                        <template x-for="p in balances" :key="p.name">
                            <div class="flex justify-between items-end border-b border-slate-50 pb-3">
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1" x-text="p.name"></p>
                                    <p class="font-extrabold text-lg" :class="p.val >= 0 ? 'text-emerald-600' : 'text-orange-500'" x-text="formatMoney(p.val)"></p>
                                </div>
                                <button x-show="p.val < -0.01" @click="startSettle(p)" class="text-[10px] font-bold text-blue-600 border border-blue-100 px-3 py-1.5 rounded-lg hover:bg-blue-600 hover:text-white uppercase transition-all">Pagar</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div x-show="!settle.active" class="card-solid transition-all duration-300" :class="editingId ? 'border-amber-400 bg-amber-50 shadow-amber-100' : 'border-emerald-50 bg-white'">
                    <h3 class="font-bold mb-6 flex items-center gap-2 uppercase text-sm tracking-tighter" :class="editingId ? 'text-amber-800' : 'text-[#064e3b]'">
                        <i :class="editingId ? 'fas fa-edit' : 'fas fa-plus-circle'"></i> 
                        <span x-text="editingId ? 'Editando Gasto' : 'Novo Gasto'"></span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Descri√ß√£o</label>
                            <input type="text" x-model="form.desc" class="w-full mt-1 bg-white" placeholder="O que comprou?">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Valor Total</label>
                                <input type="number" x-model="form.amount" class="w-full font-bold bg-white" placeholder="0.00">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Categoria</label>
                                <select x-model="form.category" class="w-full mt-1 font-semibold text-slate-700 bg-white">
                                    <template x-for="cat in categories"><option :value="cat.id" x-text="cat.label"></option></template>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Quem Pagou?</label>
                            <select x-model="form.payer" class="w-full mt-1 font-semibold text-slate-700 bg-white">
                                <template x-for="p in peopleNames"><option :value="p" x-text="p"></option></template>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Dividir com:</label>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <template x-for="p in peopleNames">
                                    <button @click="toggleInv(p)" :class="form.involved.includes(p) ? 'active-chip' : 'bg-slate-100 text-slate-400'" class="px-3 py-2 rounded-xl text-xs font-bold transition-all" x-text="p"></button>
                                </template>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button x-show="editingId" @click="cancelEdit()" class="flex-1 bg-slate-200 text-slate-600 font-bold py-4 rounded-xl text-xs uppercase">Cancelar</button>
                            <button @click="saveT()" class="flex-[2] py-4 rounded-xl shadow-md uppercase tracking-widest text-xs" :class="editingId ? 'btn-amber' : 'btn-emerald'">
                                <span x-text="editingId ? 'Atualizar Gasto' : 'Salvar Gasto'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="settle.active" x-transition class="card-solid bg-blue-50 border-blue-200 shadow-lg">
                    <h3 class="font-bold text-blue-800 mb-4 text-sm uppercase tracking-tighter italic">Pagar Gasto Espec√≠fico</h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-white rounded-xl border border-blue-100">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Pagador:</span>
                            <p class="font-bold text-blue-600 text-lg" x-text="settle.from"></p>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase ml-1">Escolha o item no hist√≥rico</label>
                            <select x-model="settle.selectedGastoIndex" @change="updateSettleAmount()" class="w-full mt-1 bg-white">
                                <option value="">-- Qual gasto voc√™ est√° pagando? --</option>
                                <template x-for="(g, index) in getPendentes(settle.from)" :key="index">
                                    <option :value="index" x-text="`${g.desc} (${formatMoney(g.share)})`"></option>
                                </template>
                            </select>
                        </div>
                        <div x-show="settle.selectedGastoIndex !== ''" class="p-3 bg-white rounded-xl border border-blue-100">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Confirmar valor</label>
                            <input type="number" x-model="settle.amount" class="w-full text-2xl font-black text-slate-700 mt-1 border-none focus:ring-0 p-0">
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button @click="settle.active = false" class="flex-1 text-xs font-bold text-slate-400 uppercase">Voltar</button>
                            <button @click="confirmSettle()" class="flex-2 bg-blue-600 text-white px-6 py-4 rounded-xl font-bold text-sm shadow-md">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4">
                <div class="card-solid max-h-[85vh] flex flex-col">
                    <div class="border-b pb-4 mb-4">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 uppercase text-xs tracking-widest"><i class="fas fa-history text-slate-400"></i> Hist√≥rico</h3>
                        
                        <div class="relative mb-3">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-300 text-xs"></i>
                            <input type="text" x-model="filters.search" placeholder="Procurar..." class="w-full !pl-8 !py-2 !text-xs">
                        </div>

                        <div class="flex gap-1 overflow-x-auto pb-1 border-t pt-2">
                            <button @click="filters.category = 'all'" :class="filters.category === 'all' ? 'bg-slate-200 text-slate-600' : 'text-slate-400'" class="text-[9px] font-bold px-2 py-1 rounded">Todas</button>
                            <template x-for="cat in categories">
                                <button @click="filters.category = cat.id" :class="filters.category === cat.id ? 'bg-emerald-100 text-emerald-700' : 'text-slate-400'" class="text-[9px] font-bold px-2 py-1 rounded whitespace-nowrap" x-text="cat.label"></button>
                            </template>
                        </div>
                    </div>

                    <div class="space-y-3 overflow-y-auto pr-2 flex-1">
                        <template x-for="t in filteredTransactions" :key="t.id">
                            <div class="p-4 border border-slate-50 bg-slate-50/50 rounded-2xl relative group hover:bg-white hover:border-slate-100 transition-all"
                                 :class="editingId === t.id ? 'border-amber-400 ring-2 ring-amber-100' : ''">
                                
                                <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                    <button @click="editT(t)" class="text-amber-500 hover:text-amber-700 text-xs"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteT(t.id)" class="text-slate-300 hover:text-red-500 text-xs"><i class="fas fa-times-circle"></i></button>
                                </div>

                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-sm text-slate-800 truncate pr-10" x-text="t.desc"></p>
                                        <span class="cat-tag mt-1" :class="t.isSettle ? 'bg-blue-100 text-blue-600' : 'bg-slate-200 text-slate-500'" x-text="t.isSettle ? 'PAGO' : t.category"></span>
                                    </div>
                                    <span class="text-[9px] font-bold text-slate-300" x-text="formatDate(t.timestamp)"></span>
                                </div>

                                <div class="flex justify-between items-center mt-3">
                                    <p class="text-[10px] text-slate-500 font-medium italic">
                                        <span x-show="!t.isSettle">Pagador: <b class="text-slate-700 not-italic" x-text="t.payer"></b></span>
                                        <span x-show="t.isSettle"><b x-text="t.payer"></b> ‚Üí <b x-text="t.receiver"></b></span>
                                    </p>
                                    <p class="font-black text-sm" :class="t.isSettle ? 'text-blue-500' : 'text-emerald-700'" x-text="formatMoney(t.amount)"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAngE5jObRFj2PU21JJ5lSFIqGHJLsxYvI",
            authDomain: "geringonca-53f0e.firebaseapp.com",
            databaseURL: "https://geringonca-53f0e-default-rtdb.firebaseio.com",
            projectId: "geringonca-53f0e",
            storageBucket: "geringonca-53f0e.firebasestorage.app",
            messagingSenderId: "42504617040",
            appId: "1:42504617040:web:a5ee3fe5530c54e5be2555"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function app() {
            return {
                SECRET_PASS: '1234', 
                logged: false,
                passInput: '',
                editingId: null,

                peopleList: [], peopleNames: [], transactions: [], balances: [], newName: '',
                categories: [
                    { id: 'festa', label: 'Festa ü•≥' },
                    { id: 'uber', label: 'Uber üöó' },
                    { id: 'floripa', label: 'Floripa üèùÔ∏è' },
                    { id: 'outros', label: 'Outros üì¶' }
                ],
                form: { desc: '', amount: '', payer: '', involved: [], category: 'outros' },
                settle: { active: false, from: '', to: '', amount: 0, selectedGastoIndex: '' },
                filters: { search: '', category: 'all' },

                init() {
                    if (localStorage.getItem('geringonca_auth') === 'true') this.logged = true;

                    db.ref('integrantes').on('value', (s) => {
                        const data = s.val() || {};
                        this.peopleList = Object.keys(data).map(key => ({ id: key, name: data[key] }));
                        this.peopleNames = this.peopleList.map(p => p.name);
                        this.resetForm();
                        this.calculate();
                    });

                    db.ref('transacoes').on('value', (s) => {
                        const data = s.val() ? Object.values(s.val()) : [];
                        this.transactions = data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        this.calculate();
                    });
                },

                checkPass() {
                    if (this.passInput === this.SECRET_PASS) {
                        this.logged = true;
                        localStorage.setItem('geringonca_auth', 'true');
                    } else { alert('Senha errada!'); this.passInput = ''; }
                },

                logout() { this.logged = false; localStorage.removeItem('geringonca_auth'); },

                getPendentes(userName) {
                    return this.transactions
                        .filter(t => !t.isSettle && t.involved.includes(userName) && t.payer !== userName)
                        .map(t => ({ desc: t.desc, share: t.amount / (t.involved.length || 1), payerOriginal: t.payer }));
                },

                updateSettleAmount() {
                    if(this.settle.selectedGastoIndex === '') return;
                    const sel = this.getPendentes(this.settle.from)[this.settle.selectedGastoIndex];
                    this.settle.amount = sel.share.toFixed(2);
                    this.settle.to = sel.payerOriginal;
                },

                get filteredTransactions() {
                    return this.transactions.filter(t => {
                        const matchesSearch = t.desc.toLowerCase().includes(this.filters.search.toLowerCase());
                        const matchesCat = this.filters.category === 'all' || t.category === this.filters.category;
                        return matchesSearch && matchesCat;
                    });
                },

                addP() { if (this.newName.trim()) { db.ref('integrantes').push(this.newName.trim()); this.newName = ''; } },
                removeP(id) { if (confirm('Remover?')) db.ref('integrantes/' + id).remove(); },
                toggleInv(name) { 
                    this.form.involved.includes(name) ? 
                    this.form.involved = this.form.involved.filter(n => n !== name) : 
                    this.form.involved.push(name); 
                },

                saveT() {
                    if(!this.form.desc || !this.form.amount || this.form.involved.length === 0) return alert('Campos vazios!');
                    
                    const payload = {
                        desc: this.form.desc, 
                        amount: parseFloat(this.form.amount),
                        payer: this.form.payer, 
                        involved: [...this.form.involved], 
                        category: this.form.category, 
                        isSettle: false
                    };

                    if(this.editingId) {
                        db.ref('transacoes/' + this.editingId).update(payload);
                        this.editingId = null;
                    } else {
                        const newRef = db.ref('transacoes').push();
                        payload.id = newRef.key;
                        payload.timestamp = Date.now();
                        newRef.set(payload);
                    }
                    this.resetForm();
                },

                editT(t) {
                    if(t.isSettle) return alert('Pagamentos n√£o podem ser editados, apenas exclu√≠dos.');
                    this.settle.active = false;
                    this.editingId = t.id;
                    this.form = {
                        desc: t.desc,
                        amount: t.amount,
                        payer: t.payer,
                        involved: [...t.involved],
                        category: t.category
                    };
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                cancelEdit() { this.editingId = null; this.resetForm(); },

                resetForm() {
                    this.form = { 
                        desc: '', 
                        amount: '', 
                        payer: this.peopleNames[0] || '', 
                        involved: [...this.peopleNames], 
                        category: 'outros' 
                    };
                },

                startSettle(p) {
                    this.cancelEdit();
                    this.settle.active = true;
                    this.settle.from = p.name;
                    this.settle.selectedGastoIndex = '';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                confirmSettle() {
                    if(this.settle.selectedGastoIndex === '') return;
                    const sel = this.getPendentes(this.settle.from)[this.settle.selectedGastoIndex];
                    const newRef = db.ref('transacoes').push();
                    newRef.set({
                        id: newRef.key, desc: `Pago: ${sel.desc}`, amount: parseFloat(this.settle.amount),
                        payer: this.settle.from, receiver: sel.payerOriginal, isSettle: true,
                        timestamp: Date.now()
                    });
                    this.settle.active = false;
                },

                deleteT(id) { if(confirm('Apagar permanentemente?')) db.ref('transacoes/' + id).remove(); },

                calculate() {
                    let b = {}; this.peopleNames.forEach(name => b[name] = 0);
                    this.transactions.forEach(t => {
                        if(t.isSettle) {
                            if(b[t.payer] !== undefined) b[t.payer] += parseFloat(t.amount);
                            if(b[t.receiver] !== undefined) b[t.receiver] -= parseFloat(t.amount);
                        } else {
                            const involved = t.involved || [];
                            const share = t.amount / (involved.length || 1);
                            if (b[t.payer] !== undefined) b[t.payer] += parseFloat(t.amount);
                            involved.forEach(name => { if (b[name] !== undefined) b[name] -= share; });
                        }
                    });
                    this.balances = Object.keys(b).map(name => ({ name, val: b[name] }));
                },

                formatMoney(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); },
                formatDate(ts) {
                    const d = new Date(ts);
                    return isNaN(d) ? '' : d.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
                }
            }
        }
    </script>
</body>
</html>